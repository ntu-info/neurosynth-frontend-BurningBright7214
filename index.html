<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeuroSynth 快速查詢 | mil.psy.ntu.edu.tw</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f5f8ff',
              100: '#e8eefc',
              200: '#d4def9',
              300: '#b1c3f3',
              400: '#8199ea',
              500: '#5670dd',
              600: '#3f55be',
              700: '#35489a',
              800: '#2e3e7c',
              900: '#293566'
            }
          }
        }
      }
    };
  </script>
  <style>
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .bg-gradient-animated {
      background: linear-gradient(-45deg, #f5f8ff, #e8eefc, #f0f9ff, #faf5ff);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }
    
    .shadow-soft { 
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.05); 
    }
    
    .shadow-hover {
      transition: all 0.3s ease;
    }
    
    .shadow-hover:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 8px 24px rgba(63,85,190,0.15);
      transform: translateY(-2px);
    }
    
    .card-gradient {
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      border: 1px solid rgba(63, 85, 190, 0.08);
    }
    
    .pill-hover {
      transition: all 0.2s ease;
    }
    
    .pill-hover:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(63, 85, 190, 0.2);
    }
    
    .input-focus {
      transition: all 0.2s ease;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .table-modern {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .table-modern thead th {
      background: linear-gradient(135deg, #3f55be 0%, #5670dd 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
      padding: 0.875rem 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .table-modern thead th:first-child {
      border-top-left-radius: 0.5rem;
    }
    
    .table-modern thead th:last-child {
      border-top-right-radius: 0.5rem;
    }
    
    .table-modern tbody tr {
      transition: background-color 0.15s ease;
    }
    
    .table-modern tbody tr:hover {
      background-color: rgba(86, 112, 221, 0.04);
    }
    
    .table-modern tbody tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.01);
    }
    
    .table-modern tbody td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
  </style>
</head>
<body class="bg-gradient-animated text-gray-900 min-h-screen">
  <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-soft border-b border-brand-100/50">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-brand-600 to-brand-700 flex items-center justify-center text-white font-bold text-lg shadow-lg">
          🧠
        </div>
        <div>
          <h1 class="text-lg sm:text-xl font-bold bg-gradient-to-r from-brand-700 to-brand-500 bg-clip-text text-transparent">NeuroSynth 即時查詢</h1>
          <p class="text-xs sm:text-sm text-gray-500">
            <span class="inline-flex items-center gap-1">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
              <a class="underline decoration-dotted hover:text-brand-700 transition-colors" href="https://mil.psy.ntu.edu.tw:5000" target="_blank" rel="noreferrer">mil.psy.ntu.edu.tw:5000</a>
            </span>
          </p>
        </div>
      </div>
      <a href="https://github.com/ntu-info/neurosynth-frontend-BurningBright7214" target="_blank" rel="noreferrer" class="hidden sm:inline-flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:text-brand-700 bg-gray-50 hover:bg-brand-50 rounded-lg transition-all duration-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .5a12 12 0 0 0-3.793 23.4c.6.112.82-.262.82-.58 0-.287-.01-1.048-.016-2.056-3.338.726-4.042-1.61-4.042-1.61-.546-1.387-1.334-1.757-1.334-1.757-1.09-.746.083-.731.083-.731 1.205.085 1.84 1.238 1.84 1.238 1.072 1.837 2.812 1.306 3.497.998.108-.776.42-1.306.763-1.607-2.665-.304-5.466-1.333-5.466-5.932 0-1.31.469-2.382 1.236-3.222-.124-.303-.536-1.523.117-3.176 0 0 1.008-.322 3.3 1.23a11.5 11.5 0 0 1 6.006 0c2.291-1.552 3.298-1.23 3.298-1.23.654 1.653.242 2.873.119 3.176.769.84 1.235 1.912 1.235 3.222 0 4.61-2.805 5.625-5.478 5.922.432.372.818 1.104.818 2.225 0 1.607-.015 2.904-.015 3.299 0 .321.217.698.826.58A12 12 0 0 0 12 .5Z"/></svg>
        <span class="font-medium">GitHub</span>
      </a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-10">
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
      <!-- Terms 相關詞查詢卡片 -->
      <div class="card-gradient rounded-2xl shadow-soft shadow-hover p-6 sm:p-7">
        <div class="flex items-center gap-3 mb-3">
          <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
            </svg>
          </div>
          <div class="flex-1">
            <h2 class="text-lg sm:text-xl font-bold text-gray-900">Terms 相關詞即時查詢</h2>
            <p class="text-xs text-gray-500 mt-0.5">輸入即搜尋，無需按 Enter</p>
          </div>
        </div>
        
        <div class="bg-brand-50/50 rounded-lg p-3 mb-4">
          <code class="text-xs text-brand-700 font-mono">GET /terms/&lt;term&gt;</code>
        </div>
        
        <div class="flex items-center gap-2 mb-3">
          <div class="relative flex-1">
            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
            <input id="termInput" type="text" placeholder="例如：amygdala" class="w-full rounded-xl border-2 border-gray-200 focus:border-brand-500 focus:ring-4 focus:ring-brand-100 pl-11 pr-11 py-3 outline-none transition-all duration-200 bg-white shadow-sm" />
            <button id="clearTerm" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-brand-600 transition-colors" aria-label="清除">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811 4.81 6.225 10.586 12l-5.775 5.775 1.414 1.414L12 13.414l5.775 5.775 1.414-1.414L13.414 12l5.775-5.775-1.414-1.414L12 10.586z"/></svg>
            </button>
          </div>
          <button id="loadAllTerms" class="flex items-center gap-2 px-4 py-3 text-sm font-medium text-brand-700 bg-brand-100 hover:bg-brand-200 rounded-xl transition-all duration-200 whitespace-nowrap shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
            全部
          </button>
        </div>
        
        <div class="flex items-center gap-2 text-xs text-gray-600 bg-amber-50 border border-amber-200 rounded-lg p-2.5 mb-4">
          <svg class="w-4 h-4 text-amber-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          <span>點擊結果可將該詞加入右側邏輯查詢</span>
        </div>
        
        <div id="termStatus" class="mt-4 text-sm hidden"></div>
        <div id="termResults" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
      </div>

      <!-- Studies 邏輯查詢卡片 -->
      <div class="card-gradient rounded-2xl shadow-soft shadow-hover p-6 sm:p-7">
        <div class="flex items-center gap-3 mb-3">
          <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
            </svg>
          </div>
          <div class="flex-1">
            <h2 class="text-lg sm:text-xl font-bold text-gray-900">Studies 邏輯查詢</h2>
            <p class="text-xs text-gray-500 mt-0.5">支援 AND、OR、NOT 邏輯運算</p>
          </div>
        </div>
        
        <div class="bg-purple-50/50 rounded-lg p-3 mb-4">
          <code class="text-xs text-purple-700 font-mono">GET /query/&lt;q_string&gt;/studies</code>
        </div>
        
        <div class="relative mb-4">
          <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <input id="queryInput" type="text" placeholder="例如：amygdala not emotion" class="w-full rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-100 pl-11 pr-11 py-3 outline-none transition-all duration-200 bg-white shadow-sm" />
          <button id="clearQuery" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-600 transition-colors" aria-label="清除">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811 4.81 6.225 10.586 12l-5.775 5.775 1.414 1.414L12 13.414l5.775 5.775 1.414-1.414L13.414 12l5.775-5.775-1.414-1.414L12 10.586z"/></svg>
          </button>
        </div>
        
        <div class="flex flex-wrap gap-2 mb-4">
          <span class="text-xs text-gray-500 font-medium">快速範例：</span>
          <button data-q="amygdala" class="preset pill-hover px-3 py-1.5 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 text-purple-700 text-xs font-medium">amygdala</button>
          <button data-q="amygdala not emotion" class="preset pill-hover px-3 py-1.5 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 text-purple-700 text-xs font-medium">amygdala NOT emotion</button>
          <button data-q="emotion and memory" class="preset pill-hover px-3 py-1.5 rounded-full bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 text-purple-700 text-xs font-medium">emotion AND memory</button>
        </div>
        
        <div id="queryStatus" class="mt-4 text-sm hidden"></div>
        <div id="queryResults" class="mt-4 overflow-x-auto"></div>
      </div>
    </section>

    <section class="mt-8 sm:mt-12">
      <div class="card-gradient rounded-2xl shadow-soft shadow-hover p-6 sm:p-7">
        <div class="flex items-center gap-3 mb-4">
          <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-teal-600 shadow-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
            </svg>
          </div>
          <div>
            <h3 class="text-lg sm:text-xl font-bold text-gray-900">API 端點測試</h3>
            <p class="text-xs text-gray-500 mt-0.5">直接測試後端 API 回應</p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <a href="https://mil.psy.ntu.edu.tw:5000/terms" target="_blank" rel="noreferrer" class="group flex items-center gap-3 p-4 bg-gradient-to-br from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 rounded-xl border border-blue-200 transition-all duration-200 shadow-sm hover:shadow-md">
            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white font-bold text-sm">1</div>
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium text-blue-900 mb-0.5">所有術語</div>
              <code class="text-xs text-blue-700 font-mono">/terms</code>
            </div>
            <svg class="w-5 h-5 text-blue-600 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
            </svg>
          </a>
          
          <a href="https://mil.psy.ntu.edu.tw:5000/terms/amygdala" target="_blank" rel="noreferrer" class="group flex items-center gap-3 p-4 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 rounded-xl border border-purple-200 transition-all duration-200 shadow-sm hover:shadow-md">
            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center text-white font-bold text-sm">2</div>
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium text-purple-900 mb-0.5">相關術語</div>
              <code class="text-xs text-purple-700 font-mono">/terms/amygdala</code>
            </div>
            <svg class="w-5 h-5 text-purple-600 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
            </svg>
          </a>
          
          <a href="https://mil.psy.ntu.edu.tw:5000/query/amygdala%20not%20emotion/studies" target="_blank" rel="noreferrer" class="group flex items-center gap-3 p-4 bg-gradient-to-br from-green-50 to-teal-50 hover:from-green-100 hover:to-teal-100 rounded-xl border border-green-200 transition-all duration-200 shadow-sm hover:shadow-md">
            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center text-white font-bold text-sm">3</div>
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium text-green-900 mb-0.5">邏輯查詢</div>
              <code class="text-xs text-green-700 font-mono truncate block">/query/.../studies</code>
            </div>
            <svg class="w-5 h-5 text-green-600 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
            </svg>
          </a>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-white/80 backdrop-blur-md border-t border-gray-200 mt-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-brand-600 to-brand-700 flex items-center justify-center text-white font-bold shadow-md">
            🧠
          </div>
          <div class="text-sm text-gray-600">
            <span class="font-semibold text-gray-900">NeuroSynth Frontend</span>
            <span class="mx-2">·</span>
            <span>© <span id="year"></span></span>
          </div>
        </div>
        <div class="flex items-center gap-6 text-xs text-gray-500">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
            </svg>
            <span>Tailwind CSS</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
            </svg>
            <span>NTU MIL Backend</span>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <template id="spinnerTmpl">
    <div class="inline-flex items-center gap-2.5 px-4 py-2 bg-brand-50 border border-brand-200 rounded-full">
      <svg class="h-5 w-5 animate-spin text-brand-600" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
      <span class="text-sm font-medium text-brand-700">載入中…</span>
    </div>
  </template>

  <script>
    const API_BASE = 'https://mil.psy.ntu.edu.tw:5000';

    const termInput = document.getElementById('termInput');
    const termStatus = document.getElementById('termStatus');
    const termResults = document.getElementById('termResults');
    const clearTermBtn = document.getElementById('clearTerm');
    const loadAllTermsBtn = document.getElementById('loadAllTerms');

    const queryInput = document.getElementById('queryInput');
    const queryStatus = document.getElementById('queryStatus');
    const queryResults = document.getElementById('queryResults');
    const clearQueryBtn = document.getElementById('clearQuery');

    document.getElementById('year').textContent = new Date().getFullYear();

    function createSpinner() {
      const t = document.getElementById('spinnerTmpl');
      return t.content.cloneNode(true);
    }

    function show(el, visible) {
      el.classList.toggle('hidden', !visible);
    }

    function debounce(fn, delayMs) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delayMs);
      };
    }

    function renderPills(container, items, onClick) {
      container.innerHTML = '';
      if (!Array.isArray(items) || items.length === 0) {
        container.innerHTML = '<div class="flex items-center justify-center gap-2 text-gray-400 py-8"><svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span>無結果</span></div>';
        return;
      }
      const frag = document.createDocumentFragment();
      for (const item of items) {
        const text = typeof item === 'string' ? item : (item.term || item.name || JSON.stringify(item));
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'pill-hover px-4 py-2 rounded-full bg-gradient-to-r from-blue-100 to-indigo-100 hover:from-blue-200 hover:to-indigo-200 text-sm font-medium text-blue-900 text-left truncate border border-blue-200 shadow-sm';
        btn.title = text;
        btn.textContent = text;
        btn.addEventListener('click', () => onClick(text));
        frag.appendChild(btn);
      }
      container.appendChild(frag);
    }

    function renderTable(container, data) {
      container.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div class="flex items-center justify-center gap-2 text-gray-400 py-8"><svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg><span>無研究結果</span></div>';
        return;
      }
      if (typeof data[0] !== 'object' || data[0] === null) {
        container.innerHTML = '<pre class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 text-xs overflow-x-auto border border-gray-200 shadow-inner">' + JSON.stringify(data, null, 2) + '</pre>';
        return;
      }
      const columns = Array.from(
        data.reduce((set, row) => {
          Object.keys(row).forEach(k => set.add(k));
          return set;
        }, new Set())
      );
      
      const wrapper = document.createElement('div');
      wrapper.className = 'rounded-xl overflow-hidden border border-gray-200 shadow-md';
      
      const table = document.createElement('table');
      table.className = 'table-modern min-w-full text-sm';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr>' + columns.map(c => '<th class="text-left">'+c+'</th>').join('') + '</tr>';
      const tbody = document.createElement('tbody');
      for (const row of data) {
        const tr = document.createElement('tr');
        for (const c of columns) {
          const v = row[c];
          const cellText = (v === null || v === undefined) ? '' : (typeof v === 'object' ? JSON.stringify(v) : String(v));
          const td = document.createElement('td');
          td.textContent = cellText;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(thead);
      table.appendChild(tbody);
      wrapper.appendChild(table);
      container.appendChild(wrapper);
    }

    function formatMs(ms) {
      return ms < 1000 ? ms + ' ms' : (ms / 1000).toFixed(2) + ' s';
    }

    function formatStatus(ok, status, bytes, ms) {
      const statusBadge = ok 
        ? `<span class="status-badge bg-green-100 text-green-700 border border-green-200">
             <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
               <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
             </svg>
             HTTP ${status}
           </span>`
        : `<span class="status-badge bg-red-100 text-red-700 border border-red-200">
             <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
               <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
             </svg>
             HTTP ${status}
           </span>`;
      
      const timeBadge = `<span class="status-badge bg-blue-100 text-blue-700 border border-blue-200">
                           <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                           </svg>
                           ${formatMs(ms)}
                         </span>`;
      
      const sizeBadge = typeof bytes === 'number' 
        ? `<span class="status-badge bg-purple-100 text-purple-700 border border-purple-200">
             <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
             </svg>
             ${(bytes / 1024).toFixed(1)} KB
           </span>`
        : '';
      
      return `<div class="flex flex-wrap items-center gap-2">${statusBadge}${timeBadge}${sizeBadge}</div>`;
    }

    function getByteLength(str) {
      try { return new TextEncoder().encode(str).length; } catch { return str.length; }
    }

    let termAbort = null;
    let queryAbort = null;

    async function fetchJson(url, signal) {
      const t0 = performance.now();
      const resp = await fetch(url, { signal, headers: { 'Accept': 'application/json' }});
      const t1 = performance.now();
      const ms = Math.round(t1 - t0);
      const text = await resp.text();
      const bytes = getByteLength(text);
      let data = null;
      let isJson = false;
      try { data = JSON.parse(text); isJson = true; } catch { data = text; }
      return { resp, ms, bytes, data, isJson };
    }

    async function runTermsSearch(term) {
      if (termAbort) termAbort.abort();
      termAbort = new AbortController();
      const url = term ? `${API_BASE}/terms/${encodeURIComponent(term)}` : `${API_BASE}/terms`;
      termStatus.innerHTML = '';
      termStatus.appendChild(createSpinner());
      show(termStatus, true);
      try {
        const { resp, ms, bytes, data } = await fetchJson(url, termAbort.signal);
        termStatus.innerHTML = formatStatus(resp.ok, resp.status, bytes, ms);
        if (!resp.ok) {
          termResults.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-xl p-4">
              <div class="flex items-center gap-2 text-red-800 font-semibold mb-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                伺服器錯誤
              </div>
              <pre class="bg-red-100/50 rounded-lg p-3 text-xs text-red-800 overflow-x-auto">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
          return;
        }
        let list = [];
        if (Array.isArray(data)) {
          list = data;
        } else if (Array.isArray(data?.terms)) {
          list = data.terms;
        } else if (Array.isArray(data?.related)) {
          list = data.related;
        } else if (data && typeof data === 'object') {
          // 如果資料是物件，嘗試找出所有可能的陣列
          const possibleArrays = Object.values(data).filter(v => Array.isArray(v));
          if (possibleArrays.length > 0) {
            list = possibleArrays[0];
          }
        }
        // 如果還是沒有資料，顯示原始 JSON 以便除錯
        if (list.length === 0 && data) {
          termResults.innerHTML = '<details class="text-xs"><summary class="cursor-pointer text-gray-600 hover:text-gray-900">顯示原始回應 (用於除錯)</summary><pre class="bg-gray-50 rounded-lg p-3 mt-2 overflow-x-auto">'+JSON.stringify(data, null, 2)+'</pre></details>';
          return;
        }
        renderPills(termResults, list, (text) => {
          if (queryInput.value && !queryInput.value.endsWith(' ')) queryInput.value += ' ';
          queryInput.value += text;
          debouncedRunQuery();
        });
      } catch (err) {
        if (err.name === 'AbortError') return;
        show(termStatus, true);
        termStatus.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-xl p-4">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-red-800 mb-1">請求失敗</h4>
                <p class="text-sm text-red-700 mb-2">${err.message || String(err)}</p>
                <p class="text-xs text-red-600">可能原因：CORS 限制、網路連線問題或伺服器暫時無法存取</p>
              </div>
            </div>
          </div>
        `;
        termResults.innerHTML = '';
      }
    }

    async function runQuerySearch(query) {
      if (queryAbort) queryAbort.abort();
      queryAbort = new AbortController();
      const url = query ? `${API_BASE}/query/${encodeURIComponent(query)}/studies` : '';
      queryStatus.innerHTML = '';
      queryResults.innerHTML = '';
      if (!url) { show(queryStatus, false); return; }
      queryStatus.appendChild(createSpinner());
      show(queryStatus, true);
      try {
        const { resp, ms, bytes, data, isJson } = await fetchJson(url, queryAbort.signal);
        queryStatus.innerHTML = formatStatus(resp.ok, resp.status, bytes, ms);
        if (!resp.ok) {
          queryResults.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-xl p-4">
              <div class="flex items-center gap-2 text-red-800 font-semibold mb-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                伺服器錯誤
              </div>
              <pre class="bg-red-100/50 rounded-lg p-3 text-xs text-red-800 overflow-x-auto">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
          return;
        }
        let resultsArray = null;
        if (Array.isArray(data)) {
          resultsArray = data;
        } else if (Array.isArray(data?.studies)) {
          resultsArray = data.studies;
        } else if (Array.isArray(data?.results)) {
          resultsArray = data.results;
        } else if (data && typeof data === 'object') {
          // 嘗試找出所有可能的陣列
          const possibleArrays = Object.entries(data).filter(([k, v]) => Array.isArray(v) && v.length > 0);
          if (possibleArrays.length > 0) {
            resultsArray = possibleArrays[0][1];
          }
        }
        
        if (resultsArray && resultsArray.length > 0) {
          renderTable(queryResults, resultsArray);
          // 顯示筆數資訊
          const count = data?.count || resultsArray.length;
          const countBadge = `<span class="status-badge bg-amber-100 text-amber-700 border border-amber-200">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                ${count} 筆研究
                              </span>`;
          const statusDiv = queryStatus.querySelector('div');
          if (statusDiv) {
            statusDiv.insertAdjacentHTML('beforeend', countBadge);
          }
        } else if (isJson) {
          queryResults.innerHTML = '<div class="flex items-center gap-2 text-amber-600 text-sm mb-3 bg-amber-50 border border-amber-200 rounded-lg p-3"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg><span>無法解析為表格，顯示原始資料</span></div><pre class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 text-xs overflow-x-auto border border-gray-200 shadow-inner">'+JSON.stringify(data, null, 2)+'</pre>';
        } else {
          queryResults.innerHTML = '<pre class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 text-xs overflow-x-auto border border-gray-200 shadow-inner">'+String(data)+'</pre>';
        }
      } catch (err) {
        if (err.name === 'AbortError') return;
        show(queryStatus, true);
        queryStatus.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-xl p-4">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-red-800 mb-1">請求失敗</h4>
                <p class="text-sm text-red-700 mb-2">${err.message || String(err)}</p>
                <p class="text-xs text-red-600">可能原因：CORS 限制、網路連線問題或伺服器暫時無法存取</p>
              </div>
            </div>
          </div>
        `;
        queryResults.innerHTML = '';
      }
    }

    const debouncedRunTerms = debounce(() => runTermsSearch(termInput.value.trim()), 200);
    const debouncedRunQuery = debounce(() => runQuerySearch(queryInput.value.trim()), 250);

    termInput.addEventListener('input', debouncedRunTerms);
    termInput.addEventListener('keydown', (e) => { if (e.key === 'Escape') { termInput.value = ''; debouncedRunTerms(); }});
    clearTermBtn.addEventListener('click', () => { termInput.value = ''; termInput.focus(); debouncedRunTerms(); });
    loadAllTermsBtn.addEventListener('click', () => runTermsSearch(''));

    queryInput.addEventListener('input', debouncedRunQuery);
    queryInput.addEventListener('keydown', (e) => { if (e.key === 'Escape') { queryInput.value = ''; debouncedRunQuery(); }});
    clearQueryBtn.addEventListener('click', () => { queryInput.value = ''; queryInput.focus(); debouncedRunQuery(); });
    document.querySelectorAll('.preset').forEach(btn => btn.addEventListener('click', () => { queryInput.value = btn.dataset.q; debouncedRunQuery(); }));

    // 初始載入：預載 amygdala 相關詞，示範 UI
    runTermsSearch('amygdala');
  </script>
</body>
</html>

