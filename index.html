<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeuroSynth 快速查詢 | mil.psy.ntu.edu.tw</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f5f8ff',
              100: '#e8eefc',
              200: '#d4def9',
              300: '#b1c3f3',
              400: '#8199ea',
              500: '#5670dd',
              600: '#3f55be',
              700: '#35489a',
              800: '#2e3e7c',
              900: '#293566'
            }
          }
        }
      }
    };
  </script>
  <style>
    .shadow-soft { box-shadow: 0 1px 2px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.06); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-white sticky top-0 z-10 shadow-soft">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-md bg-brand-600 flex items-center justify-center text-white font-semibold">N</div>
        <div>
          <h1 class="text-lg sm:text-xl font-semibold">NeuroSynth 即時查詢</h1>
          <p class="text-xs sm:text-sm text-gray-500">資料來源：<a class="underline decoration-dotted hover:text-brand-700" href="https://mil.psy.ntu.edu.tw:5000" target="_blank" rel="noreferrer">mil.psy.ntu.edu.tw:5000</a></p>
        </div>
      </div>
      <a href="https://github.com/" target="_blank" rel="noreferrer" class="hidden sm:inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .5a12 12 0 0 0-3.793 23.4c.6.112.82-.262.82-.58 0-.287-.01-1.048-.016-2.056-3.338.726-4.042-1.61-4.042-1.61-.546-1.387-1.334-1.757-1.334-1.757-1.09-.746.083-.731.083-.731 1.205.085 1.84 1.238 1.84 1.238 1.072 1.837 2.812 1.306 3.497.998.108-.776.42-1.306.763-1.607-2.665-.304-5.466-1.333-5.466-5.932 0-1.31.469-2.382 1.236-3.222-.124-.303-.536-1.523.117-3.176 0 0 1.008-.322 3.3 1.23a11.5 11.5 0 0 1 6.006 0c2.291-1.552 3.298-1.23 3.298-1.23.654 1.653.242 2.873.119 3.176.769.84 1.235 1.912 1.235 3.222 0 4.61-2.805 5.625-5.478 5.922.432.372.818 1.104.818 2.225 0 1.607-.015 2.904-.015 3.299 0 .321.217.698.826.58A12 12 0 0 0 12 .5Z"/></svg>
        <span>GitHub</span>
      </a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-10">
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
      <div class="bg-white rounded-xl shadow-soft p-5 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold mb-1">Terms 相關詞即時查詢</h2>
        <p class="text-xs sm:text-sm text-gray-500 mb-4">輸入一個術語，自動呼叫 <code class="bg-gray-100 px-1 py-0.5 rounded">/terms/&lt;term&gt;</code> 顯示相關詞。</p>
        <div class="flex items-center gap-2">
          <div class="relative flex-1">
            <input id="termInput" type="text" placeholder="例如：amygdala" class="w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 px-3 py-2 pr-10 outline-none" />
            <button id="clearTerm" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" aria-label="清除">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811 4.81 6.225 10.586 12l-5.775 5.775 1.414 1.414L12 13.414l5.775 5.775 1.414-1.414L13.414 12l5.775-5.775-1.414-1.414L12 10.586z"/></svg>
            </button>
          </div>
          <button id="loadAllTerms" class="text-sm rounded-lg border border-gray-300 hover:border-gray-400 px-3 py-2">載入全部</button>
        </div>
        <div class="mt-3 text-xs text-gray-500">提示：點擊結果可將該詞加入下方邏輯查詢。</div>
        <div id="termStatus" class="mt-4 text-sm text-gray-500 hidden"></div>
        <div id="termResults" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
      </div>

      <div class="bg-white rounded-xl shadow-soft p-5 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold mb-1">Studies 邏輯查詢</h2>
        <p class="text-xs sm:text-sm text-gray-500 mb-4">輸入查詢字串，自動呼叫 <code class="bg-gray-100 px-1 py-0.5 rounded">/query/&lt;q_string&gt;/studies</code> 顯示研究列表。</p>
        <div class="relative">
          <input id="queryInput" type="text" placeholder="例如：amygdala not emotion" class="w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 px-3 py-2 pr-10 outline-none" />
          <button id="clearQuery" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" aria-label="清除">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811 4.81 6.225 10.586 12l-5.775 5.775 1.414 1.414L12 13.414l5.775 5.775 1.414-1.414L13.414 12l5.775-5.775-1.414-1.414L12 10.586z"/></svg>
          </button>
        </div>
        <div class="mt-3 flex flex-wrap gap-2 text-xs">
          <button data-q="amygdala" class="preset px-2.5 py-1 rounded-full bg-gray-100 hover:bg-gray-200">amygdala</button>
          <button data-q="amygdala not emotion" class="preset px-2.5 py-1 rounded-full bg-gray-100 hover:bg-gray-200">amygdala not emotion</button>
          <button data-q="emotion and memory" class="preset px-2.5 py-1 rounded-full bg-gray-100 hover:bg-gray-200">emotion and memory</button>
        </div>
        <div id="queryStatus" class="mt-4 text-sm text-gray-500 hidden"></div>
        <div id="queryResults" class="mt-4 overflow-x-auto"></div>
      </div>
    </section>

    <section class="mt-8 sm:mt-12">
      <div class="bg-white rounded-xl shadow-soft p-5 sm:p-6">
        <h3 class="text-base sm:text-lg font-semibold mb-2">API 測試連結</h3>
        <ul class="list-disc pl-6 text-sm text-brand-700">
          <li><a class="underline decoration-dotted hover:text-brand-900" href="https://mil.psy.ntu.edu.tw:5000/terms" target="_blank" rel="noreferrer">/terms</a></li>
          <li><a class="underline decoration-dotted hover:text-brand-900" href="https://mil.psy.ntu.edu.tw:5000/terms/amygdala" target="_blank" rel="noreferrer">/terms/amygdala</a></li>
          <li><a class="underline decoration-dotted hover:text-brand-900" href="https://mil.psy.ntu.edu.tw:5000/query/amygdala%20not%20emotion/studies" target="_blank" rel="noreferrer">/query/amygdala%20not%20emotion/studies</a></li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="border-t bg-white">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 text-xs sm:text-sm text-gray-500">
      © <span id="year"></span> NeuroSynth demo. Frontend by Tailwind. 後端：NTU MIL.
    </div>
  </footer>

  <template id="spinnerTmpl">
    <div class="inline-flex items-center gap-2 text-gray-500">
      <svg class="h-4 w-4 animate-spin text-brand-600" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
      <span>載入中…</span>
    </div>
  </template>

  <script>
    const API_BASE = 'https://mil.psy.ntu.edu.tw:5000';

    const termInput = document.getElementById('termInput');
    const termStatus = document.getElementById('termStatus');
    const termResults = document.getElementById('termResults');
    const clearTermBtn = document.getElementById('clearTerm');
    const loadAllTermsBtn = document.getElementById('loadAllTerms');

    const queryInput = document.getElementById('queryInput');
    const queryStatus = document.getElementById('queryStatus');
    const queryResults = document.getElementById('queryResults');
    const clearQueryBtn = document.getElementById('clearQuery');

    document.getElementById('year').textContent = new Date().getFullYear();

    function createSpinner() {
      const t = document.getElementById('spinnerTmpl');
      return t.content.cloneNode(true);
    }

    function show(el, visible) {
      el.classList.toggle('hidden', !visible);
    }

    function debounce(fn, delayMs) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delayMs);
      };
    }

    function renderPills(container, items, onClick) {
      container.innerHTML = '';
      if (!Array.isArray(items) || items.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-sm">無結果</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      for (const item of items) {
        const text = typeof item === 'string' ? item : (item.term || item.name || JSON.stringify(item));
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'px-2.5 py-1 rounded-full bg-gray-100 hover:bg-gray-200 text-sm text-gray-800 text-left truncate';
        btn.title = text;
        btn.textContent = text;
        btn.addEventListener('click', () => onClick(text));
        frag.appendChild(btn);
      }
      container.appendChild(frag);
    }

    function renderTable(container, data) {
      container.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-sm">無結果</div>';
        return;
      }
      if (typeof data[0] !== 'object' || data[0] === null) {
        container.innerHTML = '<pre class="bg-gray-50 rounded-lg p-3 text-xs overflow-x-auto">' + JSON.stringify(data, null, 2) + '</pre>';
        return;
      }
      const columns = Array.from(
        data.reduce((set, row) => {
          Object.keys(row).forEach(k => set.add(k));
          return set;
        }, new Set())
      );
      const table = document.createElement('table');
      table.className = 'min-w-full text-sm';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr>' + columns.map(c => '<th class="text-left font-semibold text-gray-600 px-2 py-1 border-b">'+c+'</th>').join('') + '</tr>';
      const tbody = document.createElement('tbody');
      for (const row of data) {
        const tr = document.createElement('tr');
        for (const c of columns) {
          const v = row[c];
          const cellText = (v === null || v === undefined) ? '' : (typeof v === 'object' ? JSON.stringify(v) : String(v));
          const td = document.createElement('td');
          td.className = 'px-2 py-1 border-b align-top';
          td.textContent = cellText;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(thead);
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function formatMs(ms) {
      return ms < 1000 ? ms + ' ms' : (ms / 1000).toFixed(2) + ' s';
    }

    function formatStatus(ok, status, bytes, ms) {
      const cls = ok ? 'text-green-700' : 'text-red-700';
      const emoji = ok ? '✅' : '⚠️';
      const size = typeof bytes === 'number' ? `${bytes.toLocaleString()} B` : '';
      return `<span class="${cls}">${emoji} HTTP ${status}</span> · <span class="text-gray-600">${formatMs(ms)}</span>${size ? ' · <span class="text-gray-600">'+size+'</span>' : ''}`;
    }

    function getByteLength(str) {
      try { return new TextEncoder().encode(str).length; } catch { return str.length; }
    }

    let termAbort = null;
    let queryAbort = null;

    async function fetchJson(url, signal) {
      const t0 = performance.now();
      const resp = await fetch(url, { signal, headers: { 'Accept': 'application/json' }});
      const t1 = performance.now();
      const ms = Math.round(t1 - t0);
      const text = await resp.text();
      const bytes = getByteLength(text);
      let data = null;
      let isJson = false;
      try { data = JSON.parse(text); isJson = true; } catch { data = text; }
      return { resp, ms, bytes, data, isJson };
    }

    async function runTermsSearch(term) {
      if (termAbort) termAbort.abort();
      termAbort = new AbortController();
      const url = term ? `${API_BASE}/terms/${encodeURIComponent(term)}` : `${API_BASE}/terms`;
      termStatus.innerHTML = '';
      termStatus.appendChild(createSpinner());
      show(termStatus, true);
      try {
        const { resp, ms, bytes, data } = await fetchJson(url, termAbort.signal);
        termStatus.innerHTML = formatStatus(resp.ok, resp.status, bytes, ms);
        if (!resp.ok) {
          termResults.innerHTML = '<pre class="bg-red-50 rounded-lg p-3 text-xs text-red-800 overflow-x-auto">'+
            (typeof data === 'string' ? data : JSON.stringify(data, null, 2)) +
          '</pre>';
          return;
        }
        let list = [];
        if (Array.isArray(data)) {
          list = data;
        } else if (Array.isArray(data?.terms)) {
          list = data.terms;
        } else if (Array.isArray(data?.related)) {
          list = data.related;
        }
        renderPills(termResults, list, (text) => {
          if (queryInput.value && !queryInput.value.endsWith(' ')) queryInput.value += ' ';
          queryInput.value += text;
          debouncedRunQuery();
        });
      } catch (err) {
        if (err.name === 'AbortError') return;
        show(termStatus, true);
        termStatus.innerHTML = '<span class="text-red-700">⚠️ 請求失敗：</span> ' + (err.message || String(err)) +
          '<div class="text-xs text-gray-500 mt-1">可能原因：CORS 限制、網路或伺服器問題。</div>';
        termResults.innerHTML = '';
      }
    }

    async function runQuerySearch(query) {
      if (queryAbort) queryAbort.abort();
      queryAbort = new AbortController();
      const url = query ? `${API_BASE}/query/${encodeURIComponent(query)}/studies` : '';
      queryStatus.innerHTML = '';
      queryResults.innerHTML = '';
      if (!url) { show(queryStatus, false); return; }
      queryStatus.appendChild(createSpinner());
      show(queryStatus, true);
      try {
        const { resp, ms, bytes, data, isJson } = await fetchJson(url, queryAbort.signal);
        queryStatus.innerHTML = formatStatus(resp.ok, resp.status, bytes, ms);
        if (!resp.ok) {
          queryResults.innerHTML = '<pre class="bg-red-50 rounded-lg p-3 text-xs text-red-800 overflow-x-auto">'+
            (typeof data === 'string' ? data : JSON.stringify(data, null, 2)) +
          '</pre>';
          return;
        }
        if (Array.isArray(data)) {
          renderTable(queryResults, data);
        } else if (Array.isArray(data?.studies)) {
          renderTable(queryResults, data.studies);
        } else if (Array.isArray(data?.results)) {
          renderTable(queryResults, data.results);
        } else if (isJson) {
          queryResults.innerHTML = '<pre class="bg-gray-50 rounded-lg p-3 text-xs overflow-x-auto">'+JSON.stringify(data, null, 2)+'</pre>';
        } else {
          queryResults.innerHTML = '<pre class="bg-gray-50 rounded-lg p-3 text-xs overflow-x-auto">'+String(data)+'</pre>';
        }
      } catch (err) {
        if (err.name === 'AbortError') return;
        show(queryStatus, true);
        queryStatus.innerHTML = '<span class="text-red-700">⚠️ 請求失敗：</span> ' + (err.message || String(err)) +
          '<div class="text-xs text-gray-500 mt-1">可能原因：CORS 限制、網路或伺服器問題。</div>';
        queryResults.innerHTML = '';
      }
    }

    const debouncedRunTerms = debounce(() => runTermsSearch(termInput.value.trim()), 200);
    const debouncedRunQuery = debounce(() => runQuerySearch(queryInput.value.trim()), 250);

    termInput.addEventListener('input', debouncedRunTerms);
    termInput.addEventListener('keydown', (e) => { if (e.key === 'Escape') { termInput.value = ''; debouncedRunTerms(); }});
    clearTermBtn.addEventListener('click', () => { termInput.value = ''; termInput.focus(); debouncedRunTerms(); });
    loadAllTermsBtn.addEventListener('click', () => runTermsSearch(''));

    queryInput.addEventListener('input', debouncedRunQuery);
    queryInput.addEventListener('keydown', (e) => { if (e.key === 'Escape') { queryInput.value = ''; debouncedRunQuery(); }});
    clearQueryBtn.addEventListener('click', () => { queryInput.value = ''; queryInput.focus(); debouncedRunQuery(); });
    document.querySelectorAll('.preset').forEach(btn => btn.addEventListener('click', () => { queryInput.value = btn.dataset.q; debouncedRunQuery(); }));

    // 初始載入：預載 amygdala 相關詞，示範 UI
    runTermsSearch('amygdala');
  </script>
</body>
</html>

